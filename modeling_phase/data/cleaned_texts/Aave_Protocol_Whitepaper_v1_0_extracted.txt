protocol whitepaper v1.0 wow aave.com january 2020 abstract document describes de nitions theory aave protocol explaining di erent aspects implementation. contents 1 introduction 1 1.1 basic concepts . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1 1.2 formal de nitions . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 3 2 protocol architecture 5 2.1 lending pool core . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 5 2.2 lending pool data provider . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 5 2.3 lending pool . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 6 2.4 lending pool con gurator . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 6 2.5 interest rate strategy . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 6 2.6 governance . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 7 3 lendingpool contract 8 3.1 deposit . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 9 3.2 redeem . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 10 3.3 borrow . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 11 3.4 repay . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 12 3.5 swap rate . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 13 3.6 liquidation . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 14 3.7 flash loans . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 15 3.8 tokenization . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 16 3.8.1 limitations tokenization model . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 16 4 stable rate theory 17 4.1 lending rate oracle . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 17 4.2 current stable borrow rate rs . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 18 4.3 limitations stable rate positions . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 18 4.4 stable rate rebalancing . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 18 4.5 rebalancing process . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 19 5 conclusion 21 1 introduction birth aave protocol marks aave s shift decentralized p2p lending strategy direct loan relationship lenders borrowers, like ethlend pool-based strategy. lenders provide liquidity depositing cryptocurrencies pool contract. simultaneously, contract, pooled funds borrowed placing collateral. loans need individually matched, instead rely pooled funds, amounts borrowed collateral. enables instant loans characteristics based state pool. simpli ed scheme protocol presented gure 1 below. figure 1 aave protocol interest rate borrowers lenders decided algorithmically borrowers, depends cost money - funds available pool speci c time. funds borrowed pool, funds available decreases raises interest rate. lenders, interest rate corresponds earn rate, algorithm safeguarding liquidity reserve guarantee withdrawals time. 1.1 basic concepts figure 2 lending pool basics heart lending pool concept reserve pool holds reserves multiple currencies, total ethereum de ned total liquidity. reserve accepts deposits lenders. users 1 borrow funds, granted lock greater value collateral, backs borrow position. speci c currencies pooled reserves con gured collateral borrow positions, low risk tokens considered. borrow depends currencies deposited available reserves. reserve speci c loan-to-value ltv , calculated weighted average di erent ltvs currencies composing collateral, weight ltv equivalent collateral eth gure 3 shows example parameters. borrow position opened stable variable rate. borrows nite duration, repayment schedule partial repayments anytime. figure 3 lending pool parameters case price uctuations, borrow position liquidated. liquidation event happens price collateral drops threshold, lq, called liquidation threshold. reaching ratio channels liquida- tion bonus, incentivizes liquidators buy collateral discounted price. reserve speci c liquidation threshold, following approach ltv. calculation average liquidation threshold la q performed dynamically, weighted average liquidation thresholds collateral s underlying assets. point time, borrow position characterized health factor hf, function total col- lateral total borrows determines loan undercollateralized hf t otalcollateralet h la q t otalborrowset h t otalf eeset h hf 1, loan considered undercollateralized liquidated details liquidation found section 3.6. 2 1.2 formal de nitions variable description t, current times- tamp current number seconds de ned block.timestamp. tl, updated timestamp timestamp update reserve data. tl updated time borrow, deposit, redeem, repay, swap liquidation event occurs. t, delta time t t tl tyear, seconds number seconds year. tyear 31536000 tyear, yearly pe- riod tyear t tyear lt, total liquidity total liquidity available reserve. decimals value depend decimals currency. bs, total stable bor- rows total liquidity borrowed stable rate. decimals value depend decimals currency. bv, total variable borrows total liquidity borrowed variable rate. decimals value depend decimals currency. bt, total borrows total liquidity borrowed. deci- mals value depend decimals currency. bt bs bv u, utilization rate representing utilization deposited funds. u 0, lt 0 bt lt , lt 0 uoptimal, target uti- lization rate utilization rate targeted model, variable interest rate rises sharply. rv0, base variable borrow rate constant bt 0. expressed ray. rslope1, interest rate slope uoptimal constant representing scaling interest rate versus utilization, u uoptimal. expressed ray. rslope2, interest rate slope uoptimal constant representing scaling interest rate versus utilization, u uoptimal. expressed ray. rv, variable borrow rate rv rv0 u uoptimal rslope1, u uoptimal rv0 rslope1 u uoptimal 1 uoptimal rslope2, u uoptimal rs, stable rate implemented section 4.2. expressed ray. mr, average market lending rate base stable borrow rate, de ned platforms p r lending rate p v borrowing volume. expressed ray. mr pn 1 p rp v pn 1 p iv 3 variable description rt sa, average stable rate borrow rate stable borrow bnew issued rate rs rt sa bsrt 1 sa bnewrs bs bnew user repays bx stable rate rsx rt sa 0, bs bx 0 bsrt 1 sa bxrsx bs bx , bs bx 0 check methods decreasetotalborrowsstableandupdateaveragerate increasetotalborrowsstableandupdateaveragerate . expressed ray. ro, overall borrow rate overall borrow rate reserve, calculated weighted average total variable borrows bv total stable borrows bs. ro 0, bt 0 bvrv bsrsa bt , bt 0 rl, current liquidity rate function overall borrow rate ro utilization rate u. rl rou ct i, cumulated liq- uidity index interest cumulated reserve time interval t , updated borrow, deposit, repay, redeem, swap, liquidation event occurs. ct rl tyear 1 ct 1 c0 1 1027 1 ray n, reserve normal- ized income ongoing interest cumulated reserve. n rl tyear 1 ct 1 bt vc, cumulated vari- able borrow index interest cumulated variable borrows bv, rate rv, updated borrow, deposit, repay, redeem, swap, liquidation event occurs. bt vc 1 rv tyear txbt 1 vc b0 vc 1 1027 1 ray bt vcx, user cumu- lated variable bor- row index variable borrow index speci c user, stored user opens variable borrow position. bt vcx bt vc bx, user principal borrow balance balance stored user opens borrow position. case multiple borrows, compounded interest cumulated time new principal borrow balance. bxc, user com- pounded borrow balance principal bx plus cumulated interests. variable position bxc bvc bvcx 1 rv tyear txbx stable position bxc 1 rs tyear txbx hf, health factor hf 1, loan considered undercollater- alized liquidated hf t otalcollateralet h la q bt t otalf eeset h 4 2 protocol architecture current implementation protocol follows figure 4 protocol architecture 2.1 lending pool core lendingpoolcore contract center protocol, holds state reserve assets deposited, handles basic logic cumulation indexes, calculation interest rates... . 2.2 lending pool data provider lendingpooldataprovider contract performs calculations higher layer abstraction lendingpoolcore provides data lendingpool speci cally calculates eth equivalent user s balances borrow balance, collateral balance, liquidity balance assess user allowed borrow health factor. aggregates data lendingpoolcore provide high level information lendingpool. calculate average loan value average liquidation ratio. 5 2.3 lending pool lendingpool contract uses lendingpoolcore lendingpooldataprovider interact reserves actions deposit redeem borrow repay rate swap liquidation flash loan advanced features implemented lendingpool contract tokenization lending position. user deposits speci c reserve, receives corresponding atokens, tokens map liquidity deposited accrue interests deposited underlying assets. atokens minted deposit, value increases burned redeem liquidated. user opens borrow position, tokens collateral locked transferred. details tokenization section 3.8. 2.4 lending pool con gurator lendingpoolconfigurator provides main con guration functions lendingpool lendingpoolcore reserve initialization reserve con guration enable disable borrowing reserve enable disable usage speci c reserve collateral. lendingpoolconfigurator contract integrated aave protocol governance. 2.5 interest rate strategy interestratestrategy contract holds information needed update interest rates speci c reserve implements update interest rates. reserve speci c interestratestrategy contract. speci cally, base strategy contract defaultreserveinterestratestrategy following de ned base variable borrow rate rv0 interest rate slope optimal utilisation rslope1 interest rate slope optimal utilisation rslope2 current variable borrow rate rv rv0 u uoptimal rslope1, u uoptimal rv0 rslope1 u uoptimal 1 uoptimal rslope2, u uoptimal interest rate model allows calibration key interest rates u 0, rv rv0 u uoptimal, rv rv0 rslope1 uoptimal, interest rate rises sharply account cost capital. stable borrow rate follows model described section 4.2. 6 2.6 governance rights protocol controlled lend token. initially, aave protocol launched decentralized on-chain governance based daostack framework evolve fully autonomous protocol. on-chain implies votes binding actions follow vote hard-coded executed. understand scope governance s important distinction aave protocol bound evolve allow creation multiple lending pools segregated liquidity, parameters, permissions, type assets. aave lending pool rst pool aave protocol pool factory update released create pool. aave protocol, governance place level 1. protocol s governance voting weighted lend decisions related protocol parameters upgrades smart contract. compared makerdao s governance stakeholders vote current future parameters protocol. 2. pool s governance vote weighted based share pool liquidity expressed atokens. votes cover pool speci c parameters assets collateral borrowed. pool governance, umbrella protocol s governance. details governance published governance proposal community. 7 3 lendingpool contract actions implemented lendingpool allow users interact reserve. actions follow speci c sequence figure 5 lendingpool contract 8 3.1 deposit deposit action simplest particular state check. sequence action figure 6 deposit funds 9 3.2 redeem redeem action allows users exchange atokens underlying asset. actual redeem calculated atoken underlying exchange rate ei section 3.8. action de ned follows figure 7 redeem funds 10 3.3 borrow borrow action transfers user speci c underlying asset, exchange collateral remains locked. ow action described follows figure 8 borrow funds 11 3.4 repay repay action allows user repay completely partially borrowed plus origination fee accrued interest. figure 9 repay loan 12 3.5 swap rate swap rate action allows user borrow progress swap variable stable borrow rate. figure 10 swap rate 13 3.6 liquidation liquidationcall contract allows external actor purchase collateral discounted price. case liquidation event, maximum 50% loan liquidated, bring health factor 1. figure 11 liquidation 14 3.7 flash loans ash loan action allow users borrow reserves single transaction, long user returns liquidity taken. figure 12 flash loan flash loans temporarily transfer funds smart contract respects iflashloanenabledcontract.sol interface. address contract parameter action. funds transferred, method executeoperation executed external contract. contract action needed borrowed funds. method executeoperation completed, check performed verify funds plus fee returned lendingpool contract. fee accrued reserve, state reserve updated. funds borrowed returned reserve, transaction reverted. 15 3.8 tokenization aave protocol implements tokenization strategy liquidity providers. deposit, depositor receives corresponding derivative tokens, called aave tokens atokens short map 1 1 underlying assets. balance atokens depositor grows time, driven perpetual accrual interest deposits. atokens fully erc20 compliant. atokens natively implement concept interest rate redirection. indeed, value accrued time borrowers interest rate payments distinct principal value. balance atokens, accrued value redirected address, e ectively splitting balance generated interest. continuous ow accumulated interest time interest stream. implement tokenization strategy, aave introduced following concepts atoken contract 1. user x balance index x value reserve normalized income x moment execution action user. 2. principal balance bp balance stored balances mapping erc20 atoken contract. principal balance gets updated action user executes atoken contract deposit, redeem, transfer, liquidation, interest rate redirection 3. redirection address ar user decides redirect interest stream address, new redirection address ar provided. redirection interest stream performed, ar 0 4. redirected balance bx r user redirects interest stream, balance user redirecting added redirected balance br address speci ed br. de ned follows bx r p x bp x set users redirecting interest stream user x redirected balance decreases user x0 x redeems transfers atokens user redirecting x. 5. current balance bc balance returned balanceof function atoken contract. de ned follows bx c 0, bx p 0 bx r 0 bx p bx r ix 1 , ar 0 bx p ix bx r ix 1 , ar 0 3.8.1 limitations tokenization model described tokenization model advantages compared widely used, exchange rate based approach, drawbacks, speci cally 1. s impossible transfer balance given perpetual accrual interest rate, way specify exact transfer, interest accruing transfer transaction con rmed. means having exactly 0 balance transfer impossible, rather, small balance dust balance left account executing transfer. note avoided adding speci c logic handle particular edge case, meant adding non standard behavior erc20 transfer function, reason avoided it. relevant issue, s important note possible completely clear remaining balance 1. execute transfer, likely transfer remaining dust balance small accrue interest reasonably short time, 2. redeem dust balance transfer underlying asset. 2. interest stream redirected principal balance means accounts principal balance bp redirect interest. users redeem transfer everything, interest redirection reset. e ect this, interest generated redirected balance br redirected. 16 4 stable rate theory following chapter explains stable rates applied system limitations. implementation xed rate model pool complicated. indeed, xed rates hard handle algorithmically, cost borrowing money varies market conditions liquidity available. situations sudden market changes, bank runs ... handling stable rate borrow positions need speci c heuristics based time economical constraints. following reasoning, identi ed possible ways handling xed rates 1. imposing time constraints xed rates work perfectly ne time constrained fashion. loan stable duration, survive extreme market conditions, borrower repay end loan period. unfortunately, time constrained xed rate loans aren t suitable speci c use case open ended loan. require certain degree ux friction users need create handle multiple loans di erent times constraints. 2. imposing rates constraints interest rate calculated beginning loan impacted market conditions, keeping staying xed. rate diverges market, readjusted. pure xed rate, open term loan - rate vary loan duration users experience actual xed rates speci c time periods, liquidity available. particular implementation chosen integrated aave s protocol stable rate. 4.1 lending rate oracle figure 13 lending rate oracle rst component integrated protocol protocol lending rate oracle, provide information contracts actual market rates lending platforms, centralized decentralized, providing. average market lending rate mr de ned platforms p r lending rate p v borrowing volume mr pn 1 p rp v pn 1 p iv market rate updated daily, initially aave. 17 4.2 current stable borrow rate rs current stable borrow rate calculated follows rt s mr u uoptimal rslope1, u uoptimal mr rslope1 u uoptimal 1 uoptimal rslope2, u uoptimal - mr average market lending rate. - rslope1 interest rate slope uoptimal, increases rate u increases. - rslope2 interest rate slope uoptimal, increases di erence u uoptimal increases. - u utilization rate. note rs impact existing stable rates positions applied new opened positions. 4.3 limitations stable rate positions avoid abuses stable rate loans, following limitations applied stable rate borrowing model 1. users deposit collateral liquidity trying borrow. eg. user deposits 10 million dai collateral, tries borrow 1 million dai. prevent following attack vector given bs 18%apr, mr 9%apr, rl 12%apr users try arti cially lower bs value mr depositing huge liquidity cause bs drop, borrow liquidity lower rate, withdraw liquidity previously deposited cause bs liquidity rate rl raise nally deposit borrowed earn interest previously borrowed funds. attack carried multiple accounts, particular constraint makes attack complicated requires money di erent collateral currency . works combination interest rate rebalancing section. 2. borrowers able borrow tr available liquidity current borrow rate. so, speci c value bs, tr liquidity available single borrower. avoid speci c borrower borrow available liquidity competitive rate. 4.4 stable rate rebalancing important constraint stable rate model rate rebalancing. work changes market conditions increased cost money pool. stable rate rebalancing happen speci c situations 1. rebalancing up. stable rate user x rebalanced recent value bs user earn interest borrowing bx s rl bx s stable borrow rate user x 2. rebalancing down. stable rate user x rebalanced recent value bs, bx s bs 1 bs bs rate delta established governance de nes window bs rebalance interest rates. user pays interest range, rate balanced down. 18 4.5 rebalancing process lendingpool contract exposes function rebalancestableborrowrate address reserve, address user allows rebalance stable rate interest speci c user. anybody function however, isn t direct incentive caller rebalance rate speci c user. reason, aave provide agent periodically monitor stable rates positions rebalance ones deemed necessary. rebalance strategy decided o chain agent, means users satisfy rebalance conditions rebalanced immediately. conditions depend liquidity avail- able state market, transitory situations immediate rebalance needed. add element centralization protocol. agent stops working, anybody rebalance function lendingpool contract. isn t direct incentive it? indirect incentive ecosystem. fact, agent cease exist, depositors want trigger rebalance lowest borrow rate positions, increase liquidity rate force borrowers close positions, increasing available liquidity. case rescale down, instead, borrowers direct incentive performing rebalance positions lower interest rate. following owchart explains sequence actions function rebalancestableborrowrate . compounded balance accumulated instant rebalance happens, ected rebalance. 19 figure 14 rebalancing 20 5 conclusion aave protocol relies lending pool model o er high liquidity. loans backed collateral represented atokens, derivative tokens accrue interests. parameters interest rate loan-to-value token speci c. aave improves decentralized finance s current o ering, bringing key innovations lending ecosystem stable rates help borrowers nancial planning flash loans borrow collateral single transaction. following launch mainnet, aave uphold commitment decentralization additional features. pool factory allow launch lending pool based smart-contracts. governance on-chain rights represented lend token protocol level updates smart contract atokens pool level pool speci c parameters. 21